---
title: "Bike Sharing Demand Forecast_EDA" 
author: "Yanfei Wu"
date: "September 25, 2016"
output: 
  html_document: 
    highlight: pygments
    theme: spacelab
    keep_md: true
---

* * *

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r packages, include = F}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(corrplot)
library(caret)  
```  

```{r set theme, include = F}
theme_set(theme_bw())
```

## Introduction  

Bike sharing is a service in which bicycles are made available for shared use to individuals on a very short term basis. Using bike sharing systems, people are able to rent a bike from a one location and return it to a different location on an as-needed basis. As of August 2014, more than 600 cities worldwide had a bike-sharing program. The large amount of data generated by these bike sharing systems can serve as a sensor network. Studies on the mobility of the city can be carried out using the recorded duration of travel, departure location, arrival location, and time elapsed.    

The goal of this analysis is to explore the historical bike usage patterns combined with the weather data in the Capital Bikeshare program in Washington, D.C., and to forecast the total demand of bike rental.   

* * *

## The Data  

This project is a Kaggle competition and the datasets are obtained from [kaggle.com](https://www.kaggle.com/c/bike-sharing-demand/data). The datasets provide hourly rental data spanning two years (20110 - 2012). The training set is comprised of the first 19 days of each month, while the test set is the 20th to the end of the month.     

```{r get data}
bike <- read.csv('train.csv')
bike$datetime <- as.POSIXct(bike$datetime)
```

The training set has `r dim(bike)[1]` observations and `r dim(bike)[2]` variables. The variables include:    

* datetime: hourly date + timestamp    
* season: 1 = spring, 2 = summer, 3 = fall, 4 = winter   
* holiday: whether the day is considered a holiday  
* workingday: whether the day is neither a weekend nor holiday  
* weather:  
    + 1 = Clear, Few clouds, Partly cloudy, Partly cloudy   
    + 2 = Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist   
    + 3 = Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds   
    + 4 = Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog   
* temp: temperature in Celsius  
* atemp: "feels like" temperature in Celsius  
* humidity: relative humidity  
* windspeed: wind speed  
* casual: number of non-registered user rentals initiated  
* registered: number of registered user rentals initiated  
* count: number of total rentals  

For example, the first 6 observations look like this:  
```{r data.head}
head(bike)
```  

* * *

## Exploratory Analysis  

By looking at the provided features, some questions arise, including:  

1. What is the bike rental demand at different times of the day? And different days of the week?  
2. Is there any seasonal trend in bike rental demand?  
3. How does weather (general weather condition, temperature, humidity, and wind) affect the amount of bike rentals?  
4. Is there any pattern for casual and registered user rentals?  


### Q1. How does bike rental demand differ at different times of the day? And on different days of the week?  
To answer this question, we can do some feature engineering on the *datetime* variable and extract *hour* and *weekday* to create two new variables. The bike demand can thus be plotted as a function of hour or weekday.    

```{r hour.weekday.var}
bike$hour <- format(bike$datetime, '%H')
bike$weekday <- factor(weekdays(bike$datetime))

bike.summary <- bike %>% group_by(weekday, hour) %>% 
    summarise(median.count = median(count), 
              median.casual = median(casual),
              median.registered = median(registered))
```

```{r q1, fig.height = 8, fig.width = 7, fig.align = 'center'}
plot1 <- ggplot(bike, aes(x = hour, y = count)) + 
    geom_jitter(aes(color = weekday), alpha = 0.5) + 
    labs(x = 'Hour', y = 'Count of Bike Rentals', 
         title = 'Hourly Bike Rentals') + 
    theme(legend.title = element_blank())
    
plot2 <- ggplot(bike.summary, aes(x = hour, y = median.count, 
                group = weekday, color = weekday)) + 
    geom_line(size = 1) + 
    labs(x = 'Hour', y = 'Median Count of Bike Rentals', 
         title = 'Median Hourly Bike Rentals') + 
    theme(legend.title = element_blank())

grid.arrange(plot1, plot2, nrow = 2)
```
The plots above show that the peak hours of bike rental on *weekdays* are around 8am in the morning and 5pm in the evening, which are typical times when people go to work and get off work. The peak hours of bike rental on *weekends* are between 11am to 6pm. Again, it is consistent with most people's living habits.  

There are also some interesting day-to-day variations as shown in the *Median Hourly Bike Rentals* plot. For example, there are noticebly more people renting bikes around noon on Fridays than four other weekdays perhaps because the workload is ligher so that people can get lunch out of work places. Also, the demand is much less in Sunday afternoons than Saturday afternoons probably because people tend to stay at home in Sunday afternoons.  

The above plots do not take into account weekdays that are holidays. But there are only about 4% such days among all the given weekdays. So, we would expect the general trends between working days and non-working days to be similar to the ones shown by the above plots. 


### Q2. Is there any seasonal trend in bike rental demand?   

The bike rentals in the four different seasons can be visualized by the boxplot below.   

```{r season, fig.height = 4, fig.width = 6, fig.align = 'center'}
ggplot(bike, aes(x = factor(season), y = count)) + 
    geom_boxplot(aes(fill = factor(season))) + 
    labs(x = 'Season', y = 'Count of Bike Rentals', 
         title = 'Seasonal Bike Rentals (Jan. 2011 - Dec. 2012)') + 
    scale_fill_discrete(name = 'Season', breaks = c(1, 2, 3, 4),
                        labels = c('1-Spring', '2-Summer', 
                                   '3-Fall', '4-Winter')) 
```

It appears that the amount of bike rentals in spring is the smallest. It is counter-intuitive that even the amount of rentals in winter surpasses that in spring. Since we are dealing with time-series data, there could be some demand increases over time from Jan. 2011 to Dec. 2012. To check this, the demand over time is plotted as below.  

```{r demand.over.time, fig.height = 4, fig.width = 8, fig.align = 'center'}
# create new variable 'year-month'
bike$year.month <- format(bike$datetime, '%Y-%m')

ggplot(bike, aes(x = factor(year.month), y = count)) + 
    geom_boxplot(aes(fill = factor(season))) + 
    labs(x = 'Datetime', y = 'Count of Bike Rentals', 
         title = 'Bike Rentals over Time (Jan. 2011 - Dec. 2012)') + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
    scale_fill_discrete(name = 'Season', breaks = c(1, 2, 3, 4),
                        labels = c('Spring', 'Summer', 
                                   'Fall', 'Winter')) 
```
So it appears that the seasonal fluctuation of bike rental is actually convoluted with the overall demand increase from 2011 to 2012. The bike sharing seems to get more and more popular in Washington, D.C. over time. But still, there is a general trend showing that the demand during warm seasons (summer and fall) is higher.   


### Q3. How does weather affect the amount of bike rentals?   
There several variables in the dataset that are related to weather, including general weather condition rating, temperature, humidity, wind speed. Many of them are also related to season. Therefore, they are first explored individually and then the correlations between any two of them are examined.  

**General Weather Condition**  
There are 4 different weather conditions, from nice (1) to severe (4). The amount of bike rentals at these different weather conditions is shown below:  

```{r weather, fig.height = 4, fig.width = 6, fig.align = 'center'}
ggplot(bike, aes(x = factor(weather), y = count)) + 
    geom_boxplot(aes(fill = factor(weather))) + 
    labs(x = 'Weather', y = 'Count of Bike Rentals') + 
    scale_fill_discrete(name = 'Weather')
```

It appears that there is only 1 data point for the severe weather (4). Still, there is a noticeble trend showing larger demand with better weather condition.  

**Temperature**  
The effect of temperature on bike rental demand is shown below:  

```{r temp, fig.height = 4, fig.width = 6, fig.align = 'center'}
ggplot(bike, aes(x = temp, y = count)) + 
    geom_jitter(aes(color = temp), alpha = 0.2) + 
    labs(x = 'Temperature', y = 'Count of Bike Rentals', 
         title = 'Bike Rental vs. Temperature') +
    scale_color_gradientn(colors = c('dark blue', 'blue', 'green',
                                     'yellow', 'orange', 'red'))
```
Overall, the bike rental demand increases with temperature. The demand is the highest when the temperature is around 15-30C. We know that temperature has a strong seasonal effect. So we can add the temperature information to the bike rental demand over time plot, as shown below:    

```{r season.temp, fig.height = 5, fig.width = 7, fig.align = 'center'}
ggplot(bike, aes(x = factor(year.month), y = count)) + 
    geom_jitter(aes(color = temp), alpha = 0.2) + 
    labs(x = 'Datetime', y = 'Count of Bike Rentals', 
         title = 'Bike Rentals over Time (with Temperature info)') + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
    scale_color_gradientn(colors = c('dark blue', 'blue', 'green',
                                     'light blue', 'yellow', 'orange', 'red'))
```
The above plot shows that the seasonal fluctuation of bike rental demand (ignoring the overall demand increase with time) could be largely attributed to temperature. 

**Humidity and Wind**  
So how about humidity? And wind? Similarly, we can plot count of bike rentals vs humidity or wind, as shown below:  

```{r humidity-wind, fig.height = 4, fig.width = 9, fig.align = 'center'}
plot1 <- ggplot(bike, aes(x = humidity, y = count)) + 
    geom_jitter(color = 'blue', alpha = 0.1) + 
    labs(x = 'Humidity', y = 'Count of Bike Rentals', 
         title = 'Bike Rental vs. Humidity') 
plot2 <- ggplot(bike, aes(x = windspeed, y = count)) + 
    geom_jitter(color = 'blue', alpha = 0.1) + 
    labs(x = 'Wind', y = 'Count of Bike Rentals', 
         title = 'Bike Rental vs. Wind')
grid.arrange(plot1, plot2, ncol = 2)
``` 
It appears that there are higher bike rental demand on more humid and less windy days.  

**Correlations between season and the weather-related variables**   
It is commonly believed that there are correlations between season and weather variables, as well as between different weather variables themselves. The correlations can be visualized as below:   

```{r corr.plot, fig.height = 5, fig.width = 5, fig.align = 'center'}
bike.new <- select(bike, season, weather, temp, windspeed, humidity)
corrplot(cor(bike.new), method = 'square', diag = F, outline = T)
```
There are strong correlations between humidity and wind, general weather and humidity, as well as season with temperature, wind and humidity. 

### Q4. Is there any pattern for casual and registered user rentals?   

The casual and registered user rentals initiated are likely less important in terms of buiding our predictive model. But it is interesting to know whether there is any pattern in it. 

```{r casual.registered, fig.height = 4, fig.width = 9, fig.align = 'center'}
plot1 <- ggplot(bike, aes(x = datetime, y = casual)) + 
    geom_jitter(color = 'blue', alpha = 0.1) + 
    labs(x = 'Datetime', y = 'Count of Bike Rentals', 
         title = 'Bike Rental by Casual Users') 
plot2 <- ggplot(bike, aes(x = datetime, y = registered)) + 
    geom_jitter(color = 'blue', alpha = 0.1) + 
    labs(x = 'Datetime', y = 'Count of Bike Rentals', 
         title = 'Bike Rental by Registered Users')
grid.arrange(plot1, plot2, ncol = 2)
``` 
It is interesting to note that the number of registered user initiated bike rentals shows a significant increase over time, coupled with seasonal effect; whereas the number of casual user initiated bike rentals more closely reflects a seasonal fluctuation. This is indicative of a steady increase of registered users of the bike sharing system from 2011 to 2012. For casual users, their motivations to use the bike sharing system is still largely affected by weather factors, e.g., temperature. 

It is also expected that the bike riding habits can be different between casual bike sharing users and registered users. 

```{r casual.registered2, fig.height = 8, fig.width = 7, fig.align = 'center'}
plot1 <- ggplot(bike.summary, aes(x = hour, y = median.casual, 
                group = weekday, color = weekday)) + 
    geom_line(size = 1) + 
    labs(x = 'Hour', y = 'Median Count of Bike Rentals', 
         title = 'Median Hourly Bike Rentals by Casual Users') + 
    theme(legend.title = element_blank())
    
plot2 <- ggplot(bike.summary, aes(x = hour, y = median.registered, 
                group = weekday, color = weekday)) + 
    geom_line(size = 1) + 
    labs(x = 'Hour', y = 'Median Count of Bike Rentals', 
         title = 'Median Hourly Bike Rentals by Registered Users') + 
    theme(legend.title = element_blank())

grid.arrange(plot1, plot2, nrow = 2)
```
Indeed, casual users are more likely to initiate a bike rental on weekends, while registered users are likely taking advantage of the bike sharing system for commute to and from work. These registered users also use the bikes quite often on weekends. For the purpose of promoting the bike sharing system, it would be benefitial to build more kiosk locations near major companies in the city, or to offer discounted rate during rush hours. To target casual users, building bike kiosk locations near parks and malls would probably help.  


* * *

## Model Building  

(to be continued...)